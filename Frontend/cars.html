<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <title>Easy Car Rental</title>
    <link href="assets/lib/bootstrap-4.5.3-dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/lib/fontawesome-free-5.15.1-web/css/all.min.css" rel="stylesheet">
    <style>
        .car-list-item:hover {
            -webkit-box-shadow: 4px 4px 10px 10px rgba(200, 200, 200, 1);
            -moz-box-shadow: 4px 4px 10px 10px rgba(200, 200, 200, 1);
            box-shadow: 4px 4px 10px 10px rgba(200, 200, 200, 1);
            cursor: pointer;
        }

        .car-list-item:hover .car-image {
            transform: scale(1.1);
        }

        .modal-car-image:hover {
            transform: scale(1.2);
        }
    </style>
</head>
<body>
<header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark justify-content-around"
         style="background: black !important;">
        <a class="navbar-brand" href="index.html">
            <img alt="Easy Car Logo" src="assets/img/logo.png">
        </a>
        <div class="">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link px-3" href="index.html">Home</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link px-3" href="cars.html">Cars</a>
                </li>
                <li class="nav-item" id="navLogin">
                    <a class="nav-link px-3" data-toggle="modal" href="#loginModal">Login</a>
                </li>
                <li class="nav-item" id="navRegister">
                    <a class="nav-link px-3 text-warning" href="register.html">Register</a>
                </li>
                <li class="nav-item" id="navProfile" style="display: none;">
                    <a class="nav-link px-3 text-warning" href="profile.html">Profile</a>
                </li>
                <li class="nav-item" id="navSignOut" style="display: none;">
                    <a class="nav-link px-3 text-danger" href="#" onclick="signOut()">Sign Out</a>
                </li>
            </ul>
        </div>
    </nav>
</header>
<section class="container">
    <div>
        <h2 class="font-weight-bold text-center mt-5">What Services we offer to our clients</h2>
        <p class="text-center text-secondary mb-5">Who are in extremely love with eco friendly system.</p>
        <div class="row border mb-5">
            <div class="col-12 col-sm-6 col-md-4 col-lg-2 p-3">
                <div class="form-group border p-3">
                    <label for="sortPassengers">Passengers</label>
                    <select class="form-control rounded-0" id="sortPassengers">
                        <option selected value="any">any</option>
                    </select>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-md-4 col-lg-2 p-3">
                <div class="form-group border p-3">
                    <label for="sortTransmission">Transmission</label>
                    <select class="form-control rounded-0" id="sortTransmission">
                        <option selected value="any">any</option>
                    </select>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-md-4 col-lg-2 p-3">
                <div class="form-group border p-3">
                    <label for="sortBrand">Brand</label>
                    <select class="form-control rounded-0" id="sortBrand">
                        <option selected value="any">any</option>
                    </select>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-md-4 col-lg-2 p-3">
                <div class="form-group border p-3">
                    <label for="sortType">Type</label>
                    <select class="form-control rounded-0" id="sortType">
                        <option selected value="any">any</option>
                    </select>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-md-4 col-lg-2 p-3">
                <div class="form-group border p-3">
                    <label for="sortPrice">Price</label>
                    <select class="form-control rounded-0" id="sortPrice">
                        <option selected value="any">any</option>
                    </select>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-md-4 col-lg-2 p-3">
                <div class="form-group border p-3">
                    <label for="sortFuel">Fuel</label>
                    <select class="form-control rounded-0" id="sortFuel">
                        <option selected value="any">any</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="row" id="carRow">
        </div>
    </div>
</section>
<div aria-hidden="true" aria-labelledby="loginModalTitle" class="modal fade" id="loginModal" role="dialog"
     tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalTitle">Modal title</h5>
                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="alert alert-danger" id="loginAlert" style="display: none;"></div>
                    <div class="form-group">
                        <label for="loginUsername">Username</label>
                        <input aria-describedby="loginUsernameHelp" class="form-control rounded-0" id="loginUsername"
                               placeholder="Enter email" required type="text">
                        <small class="form-text text-danger" id="loginUsernameHelp"></small>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input aria-describedby="loginPasswordHelp" class="form-control rounded-0" id="loginPassword"
                               placeholder="Password" required
                               type="password">
                        <small class="form-text text-danger" id="loginPasswordHelp"></small>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" id="loginIsDriver" type="checkbox">
                        <label class="form-check-label" for="loginIsDriver">Is Driver?</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" type="button">Close</button>
                <button class="btn btn-warning" id="loginButton" type="button">Login</button>
            </div>
        </div>
    </div>
</div>
<div aria-hidden="true" aria-labelledby="rentModalTitle" class="modal fade" id="rentModal" role="dialog"
     tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rentModalTitle">Rent - Car</h5>
                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="lossDamage">Loss Damage Waiver - Rs0&nbsp;&nbsp;<small class="text-muted">(You need to pay Loss
                    Damage Waiver
                    to rent a car)</small></p>
                <p>Status - <span id="carStatus"></span></p>
                <hr>
                <form>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="rentPickupLocation">Pickup Location</label>
                                <input class="form-control rounded-0" id="rentPickupLocation"
                                       placeholder="Pickup Location" required type="text">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="rentPickupTime">Pickup Time</label>
                                <input class="form-control rounded-0" id="rentPickupTime" required
                                       type="datetime-local">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="rentDestination">Destination</label>
                                <input class="form-control rounded-0" id="rentDestination" placeholder="Destination"
                                       required type="text">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="rentDestinationTime">Destination Time</label>
                                <input class="form-control rounded-0" id="rentDestinationTime" required
                                       type="datetime-local">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="rentPassengers">Passengers</label>
                                <input class="form-control rounded-0" id="rentPassengers" placeholder="Passengers"
                                       required type="number">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-check">
                                <input class="form-check-input" id="rentDriver" type="checkbox">
                                <label class="form-check-label" for="rentDriver">Do you want a Driver?</label>
                            </div>
                        </div>
                    </div>
                </form>
                <hr>
                <div class="row">
                    <div class="col">
                        <img alt="" class="modal-car-image" id="modalFrontImage"
                             src="assets/img/cars/bmw/bmw-i8-front.jpg" style="width: 100%; height: 100%">
                    </div>
                    <div class="col">
                        <img alt="" class="modal-car-image" id="modalBackImage"
                             src="assets/img/cars/bmw/bmw-i8-back.jpg" style="width: 100%; height: 100%">
                    </div>
                    <div class="col">
                        <img alt="" class="modal-car-image" id="modalSlideImage"
                             src="assets/img/cars/bmw/bmw-i8-slide.jpg" style="width: 100%; height: 100%">
                    </div>
                    <div class="col">
                        <img alt="" class="modal-car-image" id="modalInteriorImage"
                             src="assets/img/cars/bmw/bmw-i8-interior.jpg" style="width: 100%; height: 100%">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" type="button">Close</button>
                <button class="btn btn-warning" id="rentCar" onclick="rentCar()" type="button" value="">Rent Car
                </button>
            </div>
        </div>
    </div>
</div>
<script src="assets/lib/jquery-3.5.1.min.js"></script>
<script src="assets/lib/popper.min.js"></script>
<script src="assets/lib/bootstrap-4.5.3-dist/js/bootstrap.min.js"></script>
<script>
    let isLogged = false;
    let userId = 'abcd';
    $.ajax({
        url: 'http://localhost:8080/carrental/api/v1/home',
        method: 'get',
        success: function (response) {
            if (response.code === 200) {
                if (response.data.loggedUser !== null) {
                    $('#loginBox').css('display', 'none');
                    $('#navLogin').css('display', 'none');
                    $('#navRegister').css('display', 'none');
                    $('#navProfile').css('display', 'block');
                    $('#navSignOut').css('display', 'block');
                    isLogged = true;
                    userId = response.data.loggedUser.id;
                } else {
                    $('#loginBox').css('display', 'block');
                    $('#navLogin').css('display', 'block');
                    $('#navRegister').css('display', 'block');
                    $('#navProfile').css('display', 'none');
                    $('#navSignOut').css('display', 'none');
                    isLogged = false;
                }
            }
        }
    });
    $.ajax({
        url: 'http://localhost:8080/carrental/api/v1/cars',
        method: 'get',
        success: function (response) {
            if (response.code === 200) {
                if (response.data != null) {
                    for (let i = 0; i < response.data.passengers.length; i++) {
                        $('#sortPassengers').append(`<option value="${response.data.passengers[i]}">${response.data.passengers[i]}</option>`)
                    }
                    for (let i = 0; i < response.data.transmissions.length; i++) {
                        $('#sortTransmission').append(`<option value="${response.data.transmissions[i]}">${response.data.transmissions[i]}</option>`)
                    }
                    for (let i = 0; i < response.data.brands.length; i++) {
                        $('#sortBrand').append(`<option value="${response.data.brands[i]}">${response.data.brands[i]}</option>`)
                    }
                    for (let i = 0; i < response.data.types.length; i++) {
                        $('#sortType').append(`<option value="${response.data.types[i]}">${response.data.types[i]}</option>`)
                    }
                    for (let i = 0; i < response.data.prices.length; i++) {
                        $('#sortPrice').append(`<option value="${response.data.prices[i]}">${response.data.prices[i]}</option>`)
                    }
                    for (let i = 0; i < response.data.fuels.length; i++) {
                        $('#sortFuel').append(`<option value="${response.data.fuels[i]}">${response.data.fuels[i]}</option>`)
                    }
                    for (let i = 0; i < response.data.cars.length; i++) {
                        $('#carRow').append(`<div class="col-12 col-sm-6 p-5 car-list-item"><div class="border"><div class="row"><div class="col-7" style="position: relative"><img alt="${response.data.cars[i].brand}" class="car-image" src="${String(response.data.cars[i].frontImage).substr(String(response.data.cars[i].frontImage).indexOf('assets'))}" style="width: 82%; height: 82%; position: absolute; top: 0; right: 0; bottom: 0; left: 0; margin: auto;"></div><div class="col-5"><p class="h4 mb-4 mt-4 mr-1 text-center font-weight-bold border p-1 ${response.data.cars[i].status === 'Available' ? 'border-success' : response.data.cars[i].status === 'available' ? 'border-success' : 'border-danger'}">${response.data.cars[i].brand}</p><hr class="mt-n3 "><p><span class="fas fa-typo3"></span>&nbsp;Type - <span class="carType">${response.data.cars[i].type}</span></p><p><span class="fas fa-chair"></span>&nbsp;No of passengers - <span class="carPassengers">${response.data.cars[i].passengers}</span></p><p><span class="fas fa-oil-can"></span>&nbsp;Fuel type - <span class="carFuel">${response.data.cars[i].fuel}</span></p><p><span class="fas fa-money-bill"></span>&nbsp;Rent price - Rs<span class="carDailyRate">${response.data.cars[i].dailyRate}</span></p><p><span class="fas fa-money-check"></span>&nbsp;Color - ${response.data.cars[i].color}</p><p><span class="fas fa-transgender"></span>&nbsp;Transmission - <span class="carTransmission">${response.data.cars[i].transmission}</span></p></div></div><button class="btn btn-warning modalRentA" id="${response.data.cars[i].id}" style="width: 100%">Rent</button></div></div>`)
                    }
                    let cars = $('#carRow > div');
                    $('#sortPassengers').on('change', function () {
                        cars.each(function () {
                            if ($(this).find('.carPassengers').text() === $('#sortPassengers').val()) {
                                $(this).css('display', 'block')
                            } else if ($('#sortPassengers').val() === 'any') {
                                $(this).css('display', 'block')
                            } else {
                                $(this).css('display', 'none')
                            }
                        })
                    });
                    $('#sortTransmission').on('change', function () {
                        cars.each(function () {
                            if ($(this).find('.carTransmission').text() === $('#sortTransmission').val()) {
                                $(this).css('display', 'block')
                            } else if ($('#sortTransmission').val() === 'any') {
                                $(this).css('display', 'block')
                            } else {
                                $(this).css('display', 'none')
                            }
                        })
                    });
                    $('#sortBrand').on('change', function () {
                        cars.each(function () {
                            if ($(this).find('.car-image').attr('alt') === $('#sortBrand').val()) {
                                $(this).css('display', 'block')
                            } else if ($('#sortBrand').val() === 'any') {
                                $(this).css('display', 'block')
                            } else {
                                $(this).css('display', 'none')
                            }
                        })
                    });
                    $('#sortType').on('change', function () {
                        cars.each(function () {
                            if ($(this).find('.carType').text() === $('#sortType').val()) {
                                $(this).css('display', 'block')
                            } else if ($('#sortType').val() === 'any') {
                                $(this).css('display', 'block')
                            } else {
                                $(this).css('display', 'none')
                            }
                        })
                    });
                    $('#sortPrice').on('change', function () {
                        cars.each(function () {
                            if ($(this).find('.carDailyRate').text() === $('#sortPrice').val()) {
                                $(this).css('display', 'block')
                            } else if ($('#sortPrice').val() === 'any') {
                                $(this).css('display', 'block')
                            } else {
                                $(this).css('display', 'none')
                            }
                        })
                    });
                    $('#sortFuel').on('change', function () {
                        cars.each(function () {
                            if ($(this).find('.carFuel').text() === $('#sortFuel').val()) {
                                $(this).css('display', 'block')
                            } else if ($('#sortFuel').val() === 'any') {
                                $(this).css('display', 'block')
                            } else {
                                $(this).css('display', 'none')
                            }
                        })
                    });
                    $('#carRow .modalRentA').on('click', function () {
                        if (isLogged) {
                            $.ajax({
                                url: 'http://localhost:8080/carrental/api/v1/cars/car/' + $(this).attr('id'),
                                method: 'get',
                                success: function (response) {
                                    if (response.code === 200) {
                                        $('#rentModal').modal('show');
                                        $('#rentModal').find('#rentModalTitle').text('Rent - ' + response.data.brand);
                                        $('#rentModal').find('#lossDamage').text('Loss Damage Waiver - Rs' + response.data.lossDamage);
                                        $('#rentModal').find('#modalFrontImage').attr('src', String(response.data.frontImage).substr(String(response.data.frontImage).indexOf('assets')));
                                        $('#rentModal').find('#modalBackImage').attr('src', String(response.data.backImage).substr(String(response.data.backImage).indexOf('assets')));
                                        $('#rentModal').find('#modalSlideImage').attr('src', String(response.data.slideImage).substr(String(response.data.slideImage).indexOf('assets')));
                                        $('#rentModal').find('#modalInteriorImage').attr('src', String(response.data.interiorImage).substr(String(response.data.interiorImage).indexOf('assets')));
                                        $('#rentModal').find('#modalFrontImage').attr('alt', response.data.brand);
                                        $('#rentModal').find('#modalBackImage').attr('alt', response.data.brand);
                                        $('#rentModal').find('#modalSlideImage').attr('alt', response.data.brand);
                                        $('#rentModal').find('#modalInteriorImage').attr('alt', response.data.brand);
                                        $('#rentModal').find('#rentCar').attr('value', response.data.id);
                                        $('#rentModal').find('#carStatus').text(response.data.status);
                                        if (response.data.status === 'Available' || response.data.status === 'Available') {
                                            $('#rentModal').find('#carStatus').removeClass('text-danger');
                                            $('#rentModal').find('#carStatus').addClass('text-success');
                                            $('#rentModal').find('#rentCar').attr('disabled', false);
                                        } else {
                                            $('#rentModal').find('#carStatus').removeClass('text-success');
                                            $('#rentModal').find('#carStatus').addClass('text-danger');
                                            $('#rentModal').find('#rentCar').attr('disabled', true);
                                        }
                                    }
                                }
                            })
                        } else {
                            $('#loginModal').modal('show');
                        }
                    });
                }
            }
        }
    });
    $('#loginModal').on('show.bs.modal', function () {
        let mdl = $(this);
        $.ajax({
            url: 'http://localhost:8080/carrental/api/v1/login',
            method: 'get',
            success: function (response) {
                if (response.code !== 200) {
                    console.log(mdl, response);
                    $('#loginModal').modal('hide');
                }
            }
        });
        $('#loginButton').on('click', function () {
            var username = $('#loginUsername').val().trim();
            var password = $('#loginPassword').val().trim();
            if (username.length < 6 || !isNaN(parseFloat(username))) {
                $('#loginUsernameHelp').text('invalid username');
            } else {
                $('#loginUsernameHelp').text('');
            }
            if (password.length < 6 || !isNaN(parseFloat(password))) {
                $('#loginPasswordHelp').text('invalid password');
            } else {
                $('#loginPasswordHelp').text('');
            }
            if ($('#loginUsernameHelp').text() === '' && $('#loginPasswordHelp').text() === '') {
                $.ajax({
                    url: 'http://localhost:8080/carrental/api/v1/login',
                    method: 'post',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        username: username,
                        password: password,
                        driver: $('#loginIsDriver').is(':checked')
                    }),
                    success: function (response) {
                        console.log(response);
                        if (response.code === 400) {
                            $('#loginAlert').css('display', 'block');
                            $('#loginAlert').text(response.data);
                        } else if (response.code === 200) {
                            window.location.reload();
                        }
                    }
                })
            }
        });
    });

    function rentCar() {
        if (isLogged) {
            $.ajax({
                url: 'http://localhost:8080/carrental/api/v1/booking/add',
                method: 'post',
                contentType: 'application/json',
                data: JSON.stringify({
                    userId: userId,
                    carId: $('#rentCar').attr('value'),
                    pickupLocation: $('#rentPickupLocation').val().trim(),
                    destination: $('#rentDestination').val().trim(),
                    pickupTime: $('#rentPickupTime').val(),
                    destinationTime: $('#rentDestinationTime').val(),
                    passengers: $('#rentPassengers').val(),
                    needDriver: $('#rentDriver').is(':checked')
                }),
                success: function (response) {
                    if (response.code === 200) {
                        if (response.data) {
                            alert('Order Placed');
                            window.location.reload()
                        } else {
                            alert(response.message + ' - ' + response.data)
                        }
                    } else {
                        alert(response.message + ' - ' + response.data)
                    }
                }
            })
        } else {
            alert('Please log before rent a car');
        }
    }

    function signOut() {
        if (isLogged) {
            if (confirm('Do you want to sign out?')) {
                $.ajax({
                    url: 'http://localhost:8080/carrental/api/v1/login/out',
                    method: 'get',
                    success: function (response) {
                        window.location.reload();
                    }
                });
            }
        } else {
            alert('Please Logged to sign out');
        }
    }
</script>
</body>
</html>