<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <title>Easy Car Rental</title>
    <link href="assets/lib/bootstrap-4.5.3-dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/lib/fontawesome-free-5.15.1-web/css/all.min.css" rel="stylesheet">
</head>
<body>
<header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark justify-content-around"
         style="background: black !important;">
        <a class="navbar-brand" href="index.html">
            <img alt="Easy Car Logo" src="assets/img/logo.png">
        </a>
        <div class="">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link px-3" href="index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link px-3" href="cars.html">Cars</a>
                </li>
                <li class="nav-item" id="navLogin">
                    <a class="nav-link px-3" data-toggle="modal" href="#loginModal">Login</a>
                </li>
                <li class="nav-item" id="navRegister">
                    <a class="nav-link px-3 text-warning" href="register.html">Register</a>
                </li>
                <li class="nav-item" id="navProfile" style="display: none;">
                    <a class="nav-link px-3 text-warning" href="profile.html">Profile</a>
                </li>
                <li class="nav-item" id="navSignOut" style="display: none;">
                    <a class="nav-link px-3 text-danger" href="#" onclick="signOut()">Sign Out</a>
                </li>
            </ul>
        </div>
    </nav>
</header>
<section class="container my-5" style="position: relative;">
    <div class="border p-5 w-75" style="position:relative; right: 0; left: 0; margin: auto;">
        <p class="h3 text-center font-weight-bold mb-5">Sign Up</p>
        <form action="" id="registerForm">
            <div class="alert alert-danger" id="registerAlert" style="display: none;"></div>
            <div class="row">
                <div class="col-12 col-lg-6">
                    <div class="form-group">
                        <label for="registerUsername">Username</label>
                        <input aria-describedby="registerUsernameHelp" class="form-control rounded-0"
                               id="registerUsername" placeholder="Username"
                               required type="text">
                        <small class="form-text text-danger" id="registerUsernameHelp"></small>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input aria-describedby="registerEmailHelp" class="form-control rounded-0" id="registerEmail"
                               placeholder="Email" required
                               type="email">
                        <small class="form-text text-danger" id="registerEmailHelp"></small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-lg-6">
                    <div class="form-group">
                        <label for="registerContact">Contact</label>
                        <input aria-describedby="registerContactHelp" class="form-control rounded-0"
                               id="registerContact" placeholder="Contact" required
                               type="number">
                        <small class="form-text text-danger" id="registerContactHelp"></small>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="form-group">
                        <label for="registerAddress">Address</label>
                        <input aria-describedby="registerAddressHelp" class="form-control rounded-0"
                               id="registerAddress" placeholder="Address" required
                               type="text">
                        <small class="form-text text-danger" id="registerAddressHelp"></small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-lg-6">
                    <div class="form-group">
                        <label for="registerNicNumber">NIC Number</label>
                        <input aria-describedby="registerNicNumberHelp" class="form-control rounded-0"
                               id="registerNicNumber" placeholder="NIC Number" required
                               type="text">
                        <small class="form-text text-danger" id="registerNicNumberHelp"></small>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="form-group">
                        <label for="registerNicPhoto">NIC Photo</label>
                        <input accept="image/jpeg,image/png" aria-describedby="registerNicPhotoHelp"
                               class="form-control rounded-0" id="registerNicPhoto" required type="file">
                        <small class="form-text text-danger" id="registerNicPhotoHelp"></small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-lg-6">
                    <div class="form-group">
                        <label for="registerDrivingLicenseNumber">Driving License Number</label>
                        <input aria-describedby="registerDrivingLicenseNumberHelp" class="form-control rounded-0"
                               id="registerDrivingLicenseNumber"
                               placeholder="Driving License Number" required
                               type="text">
                        <small class="form-text text-danger" id="registerDrivingLicenseNumberHelp"></small>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="form-group">
                        <label for="registerDrivingLicensePhoto">Driving License Photo</label>
                        <input accept="image/jpeg,image/png" aria-describedby="registerDrivingLicensePhotoHelp"
                               class="form-control rounded-0" id="registerDrivingLicensePhoto" required type="file">
                        <small class="form-text text-danger" id="registerDrivingLicensePhotoHelp"></small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-lg-6">
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input aria-describedby="registerPasswordHelp" class="form-control rounded-0"
                               id="registerPassword" placeholder="Password" required
                               type="password">
                        <small class="form-text text-danger" id="registerPasswordHelp"></small>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="form-group">
                        <label for="registerConfirmPassword">Confirm Password</label>
                        <input aria-describedby="registerConfirmPasswordHelp" class="form-control rounded-0"
                               id="registerConfirmPassword"
                               placeholder="Confirm Password" required
                               type="password">
                        <small class="form-text text-danger" id="registerConfirmPasswordHelp"></small>
                    </div>
                </div>
            </div>
            <div class="text-right mt-3">
                <input class="btn btn-warning px-5" onclick="registerUser()" type="button" value="Register">
            </div>
        </form>
    </div>
</section>
<div aria-hidden="true" aria-labelledby="loginModalTitle" class="modal fade" id="loginModal" role="dialog"
     tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalTitle">Modal title</h5>
                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="alert alert-danger" id="loginAlert" style="display: none;"></div>
                    <div class="form-group">
                        <label for="loginUsername">Username</label>
                        <input aria-describedby="loginUsernameHelp" class="form-control rounded-0" id="loginUsername"
                               placeholder="Enter email" required type="text">
                        <small class="form-text text-danger" id="loginUsernameHelp"></small>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input aria-describedby="loginPasswordHelp" class="form-control rounded-0" id="loginPassword"
                               placeholder="Password" required
                               type="password">
                        <small class="form-text text-danger" id="loginPasswordHelp"></small>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" id="loginIsDriver" type="checkbox">
                        <label class="form-check-label" for="loginIsDriver">Is Driver?</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" type="button">Close</button>
                <button class="btn btn-warning" id="loginButton" type="button">Login</button>
            </div>
        </div>
    </div>
</div>
<script src="assets/lib/jquery-3.5.1.min.js"></script>
<script src="assets/lib/popper.min.js"></script>
<script src="assets/lib/bootstrap-4.5.3-dist/js/bootstrap.min.js"></script>
<script>
    $.ajax({
        url: 'http://localhost:8080/carrental/api/v1/register',
        method: 'get',
        success: function (response) {
            if (response.code === 403) {
                window.location.replace('index.html');
            }
            if (response.code === 200) {
                if (response.data.loggedUser !== null) {
                    $('#navLogin').css('display', 'none');
                    $('#navRegister').css('display', 'none');
                    $('#navProfile').css('display', 'block');
                } else {
                    $('#navLogin').css('display', 'block');
                    $('#navRegister').css('display', 'block');
                    $('#navProfile').css('display', 'none');
                }
            }
        }
    });
    function registerUser() {
        var username = $('#registerUsername').val().trim();
        var email = $('#registerEmail').val().trim();
        var contact = $('#registerContact').val().trim();
        var address = $('#registerAddress').val().trim();
        var nicNumber = $('#registerNicNumber').val().trim();
        var nicPhoto = $('#registerNicPhoto').val();
        var drivingLicenseNumber = $('#registerDrivingLicenseNumber').val().trim();
        var drivingLicensePhoto = $('#registerDrivingLicensePhoto').val();
        var password = $('#registerPassword').val().trim();
        var confirmPassword = $('#registerConfirmPassword').val().trim();
        if (username.length < 6 || !isNaN(parseFloat(username))) {
            $('#registerUsernameHelp').text('invalid username');
        } else {
            $('#registerUsernameHelp').text('');
        }
        if (email.length < 6 || !email.match(/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/)) {
            $('#registerEmailHelp').text('invalid email');
        } else {
            $('#registerEmailHelp').text('');
        }
        if (contact.length < 9) {
            $('#registerContactHelp').text('invalid contact');
        } else {
            $('#registerContactHelp').text('');
        }
        if (address.length < 5 || !isNaN(parseFloat(address))) {
            $('#registerAddressHelp').text('invalid address');
        } else {
            $('#registerAddressHelp').text('');
        }
        if (nicNumber.length < 9) {
            $('#registerNicNumberHelp').text('invalid NIC number');
        } else {
            $('#registerNicNumberHelp').text('');
        }
        if (drivingLicenseNumber.length < 9) {
            $('#registerDrivingLicenseNumberHelp').text('invalid driving license number');
        } else {
            $('#registerDrivingLicenseNumberHelp').text('');
        }
        if (password.length < 6 || !isNaN(parseFloat(password))) {
            $('#registerPasswordHelp').text('invalid password');
        } else {
            $('#registerPasswordHelp').text('');
        }
        if (confirmPassword.length < 6 || !isNaN(parseFloat(confirmPassword)) || confirmPassword !== password) {
            $('#registerConfirmPasswordHelp').text('invalid confirm password');
        } else {
            $('#registerConfirmPasswordHelp').text('');
        }
        let bool = true;
        $('#registerForm small').each(function () {
            if ($(this).text() === '') {
                bool = true;
            } else {
                bool = false;
                return false;
            }
        });
        if (bool) {
            $.ajax({
                url: 'http://localhost:8080/carrental/api/v1/register/user',
                method: 'post',
                contentType: 'application/json',
                data: JSON.stringify({
                    username: $('#registerUsername').val().trim(),
                    email: $('#registerEmail').val().trim(),
                    contact: $('#registerContact').val().trim(),
                    address: $('#registerAddress').val().trim(),
                    nicNumber: $('#registerNicNumber').val().trim(),
                    nicPhoto: $('#registerNicPhoto').val(),
                    drivingLicenseNumber: $('#registerDrivingLicenseNumber').val().trim(),
                    drivingLicensePhoto: $('#registerDrivingLicensePhoto').val(),
                    password: $('#registerPassword').val().trim()
                }),
                success: function (response) {
                    if (response.code === 200 || response.code === 403) {
                        window.location.replace('index.html');
                    } else if(response.code === 400){
                        $('#registerAlert').css('display', 'block');
                        $('#registerAlert').text(response.data);
                    }
                }
            })
        }
    }
    $('#loginModal').on('show.bs.modal', function () {
        let mdl = $(this);
        $.ajax({
            url: 'http://localhost:8080/carrental/api/v1/login',
            method: 'get',
            success: function (response) {
                if (response.code !== 200) {
                    console.log(mdl, response);
                    $('#loginModal').modal('hide');
                }
            }
        });
        $('#loginButton').on('click', function () {
            var username = $('#loginUsername').val().trim();
            var password = $('#loginPassword').val().trim();
            if (username.length < 6 || !isNaN(parseFloat(username))) {
                $('#loginUsernameHelp').text('invalid username');
            } else {
                $('#loginUsernameHelp').text('');
            }
            if (password.length < 6 || !isNaN(parseFloat(password))) {
                $('#loginPasswordHelp').text('invalid password');
            } else {
                $('#loginPasswordHelp').text('');
            }
            if ($('#loginUsernameHelp').text() === '' && $('#loginPasswordHelp').text() === '') {
                $.ajax({
                    url: 'http://localhost:8080/carrental/api/v1/login',
                    method: 'post',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        username: username,
                        password: password,
                        driver: $('#loginIsDriver').is(':checked')
                    }),
                    success: function (response) {
                        console.log(response);
                        if (response.code === 400) {
                            $('#loginAlert').css('display', 'block');
                            $('#loginAlert').text(response.data);
                        } else if (response.code === 200) {
                            window.location.reload();
                        }
                    }
                })
            }
        });
    });
    function signOut(){
        if (confirm('Do you want to sign out?')){
            $.ajax({
                url: 'http://localhost:8080/carrental/api/v1/login/out',
                method: 'get',
                success: function (response) {
                    window.location.reload();
                }
            });
        }
    }
</script>
</body>
</html>